<?xml version="1.0" encoding="UTF-8"?>
<!--

 $Id$
 -->
<project name="eresus-cms" default="build" basedir="./">

	<property file="build.properties" />

	<php function="date" returnProperty="builddate">
	  <param value="Y-m-d"/>
	</php>

	<!--
		Clean up
	-->
	<target name="clean" description="Clean up build files">

		<echo msg="Clean up: ${dir.build}..." level="info" />

		<if>
			<available file="${dir.build}" />

			<then>
				<delete includeemptydirs="true" failonerror="true">
					<fileset dir="${dir.build}">
						<include name="**/*" />
						<exclude name=".svn" />
						<exclude name=".svn/*" />
					</fileset>
				</delete>
			</then>

		</if>

	</target>

	<!--
		Prepare for build
	-->
	<target name="prepare" depends="clean" description="Prepare for build">

		<echo msg="Build directory: ${dir.build}" level="info" />

		<echo msg="Create build directory..." level="info" />
		<mkdir dir="${dir.build}" />

		<echo msg="Ready to build" level="info" />

	</target>

	<!--
		Build project
	-->
	<target name="build" depends="prepare" description="Build project">

		<php function="date" returnProperty="build.year">
		  <param value="Y"/>
		</php>

		<echo msg="Copying main files..." level="info" />
		<copy todir="${dir.build}">
			<fileset refid="files.main" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>

		<echo msg="Copying Eresus Framework..." level="info" />
		<copy todir="${dir.build}/core/framework">
			<fileset refid="files.framework" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>

		<echo msg="Copying libraries..." level="info" />
		<copy todir="${dir.build}/core/lib">
			<fileset refid="files.lib" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>

		<echo msg="Copying l10n files..." level="info" />
		<copy todir="${dir.build}/lang">
			<fileset refid="files.l10n" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>

		<echo msg="Copying unit tests..." level="info" />
		<copy todir="${dir.build}/tests">
			<fileset refid="files.tests" />
		</copy>

<!--
		<copy todir="${builddir}/core/lib">
			<fileset refid="libs_files" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>

		<echo msg="" />
		<mkdir dir="${builddir}/distrib" />
		<copy todir="${builddir}/distrib">
			<fileset refid="db_files" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>

		<copy todir="${builddir}">
			<fileset refid="3rdparty_files" />
		</copy>

		<copy todir="${builddir}/distrib">
			<fileset refid="tools_files" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>-->

  </target>

	<!--
		Build all
	-->
	<target name="all" depends="build" description="Build all modules">

		<mkdir dir="${builddir}/distrib" />
		<copy todir="${builddir}/distrib">
			<fileset refid="SDK_files" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>

	</target>


	<!--
		Run unit tests
	-->
	<target name="test" description="Run unit tests">

		<phpunit printsummary="true">
			<formatter type="plain" usefile="false" />
			<batchtest>
				<fileset dir="${builddir}/t">
					<include name="init.php"/>
					<include name="**/*Test.php"/>
					<exclude name="**/AllTests.php"/>
				</fileset>
			</batchtest>
		</phpunit>

	</target>

	<!-- - - - - - - - - - - - - - - - - - - - - -->

	<!-- Main project files -->
	<fileset dir="main" id="files.main">
		<include name="**" />
		<exclude name=".svn" />
	</fileset>

	<!-- Framework files -->
	<fileset dir="framework" id="files.framework">
		<include name="**" />
		<exclude name=".svn" />
	</fileset>

	<!-- libs files -->
	<fileset dir="lib" id="files.lib">
		<include name="**" />
		<exclude name=".svn" />
	</fileset>

	<!-- DB templates -->
	<fileset dir="db" id="files.db">
		<include name="**" />
		<exclude name=".svn" />
	</fileset>

	<!-- l10n files -->
	<fileset dir="lang" id="files.l10n">
		<include name="**" />
		<exclude name=".svn" />
	</fileset>

	<!-- Tools files -->
	<fileset dir="." id="files.tools">
		<include name="tools/**" />
		<exclude name=".svn" />
	</fileset>

	<!-- 3rd party extensions -->
	<fileset dir="." id="files.3rdparty">
		<include name="ext-3rd/**" />
		<exclude name=".svn" />
	</fileset>

	<!-- SDK files -->
	<fileset dir="." id="files.sdk">
		<include name="SDK/**" />
		<exclude name=".svn" />
	</fileset>

	<!-- Unit tests -->
	<fileset dir="tests" id="files.tests">
		<include name="**" />
		<exclude name=".svn" />
	</fileset>

</project>
