<?xml version="1.0" encoding="UTF-8"?>

<!--
 Eresus 2

 Файл сборки проекта

 $Id$
 -->
<project name="eresus-cms" default="build" basedir="./">

	<property file="build.properties" />
	<php function="date" returnProperty="builddate">
	  <param value="Y-m-d"/>
	</php>

	<!--
	=====================================================================
		Подготовка к сборке
	=====================================================================
  -->

	<target name="prepare" description="Prepare for build">

		<echo msg="Build directory: ${build.dir}" level="info" />

		<echo msg="Clean up: ${build.dir}..." level="info" />

		<if>
			<available file="${build.dir}" />
			<then>
				<delete includeemptydirs="true" failonerror="true">
					<fileset dir="${build.dir}">
						<include name="**/*" />
						<exclude name=".svn" />
						<exclude name=".svn/*" />
					</fileset>
				</delete>
			</then>
		</if>

		<echo msg="Create build directory..." level="info" />
		<mkdir dir="${build.dir}" />

		<echo msg="Ready to build" level="info" />

	</target>

	<!--
	=====================================================================
		Сборка проекта
	=====================================================================
	-->
	<target name="build" depends="prepare" description="Build basic set of modules">

		<!-- Копирование основных файлов -->
		<copy todir="${build.dir}">
			<fileset refid="files.main" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>

			<!-- Обработка файлов CSS темы default -->
			<append destFile="${build.dir}/admin/themes/default/theme.css">
				<fileset dir="${build.dir}/admin/themes/default/css/">
					<include name="*.css" />
				</fileset>
			</append>

		<!-- Eresus Core -->
		<echo msg="Copying Eresus Core..." level="info" />
		<copy todir="${build.dir}/core/framework">
			<fileset refid="files.framework" />
			<filterchain>
				<expandproperties />
			</filterchain>
		</copy>

		<copy todir="${build.dir}/core/lib">
			<fileset refid="libs_files" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>

		<!-- jQuery -->
		<copy todir="${build.dir}/core/jquery">
			<fileset refid="files.3rd.jquery" />
		</copy>

		<copy todir="${build.dir}/">
			<fileset refid="l10n_files" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>

		<mkdir dir="${build.dir}/distrib" />
		<copy todir="${build.dir}/distrib">
			<fileset refid="db_files" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>

		<copy todir="${build.dir}">
			<fileset refid="files.3rd-ext" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>

		<!-- Tiny MCE -->
		<copy todir="${build.dir}/ext-3rd/tinymce">
			<fileset refid="files.3rd.tiny_mce" />
		</copy>

		<copy todir="${build.dir}/distrib">
			<fileset refid="tools_files" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>

		<!-- Auto tests -->
		<if>
			<istrue value="${tests}" />
			<then>
				<copy todir="${build.dir}/tests">
					<fileset refid="files.tests" />
					<filterchain>
					    <expandproperties />
				  </filterchain>
				</copy>
			</then>

		</if>
  </target>

	<!--
		Build all
	-->
	<target name="all" depends="build" description="Build all modules">

		<mkdir dir="${build.dir}/distrib" />
		<copy todir="${build.dir}/distrib">
			<fileset refid="SDK_files" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>

	</target>

	<!-- - - - - - - - - - - - - - - - - - - - - -->

	<!-- Main project files -->
	<fileset dir="main" id="files.main">
		<include name="**" />
		<exclude name=".svn" />
	</fileset>

	<!-- Framework files -->
	<fileset dir="framework" id="files.framework">
		<include name="**" />
		<exclude name=".svn" />
	</fileset>

	<!-- libs files -->
	<fileset dir="lib" id="libs_files">
		<include name="**" />
		<exclude name=".svn" />
	</fileset>

	<!-- DB templates -->
	<fileset dir="db" id="db_files">
		<include name="**" />
		<exclude name=".svn" />
	</fileset>

	<!-- l10n files -->
	<fileset dir="." id="l10n_files">
		<include name="lang/**" />
		<exclude name=".svn" />
	</fileset>

	<!-- Tools files -->
	<fileset dir="." id="tools_files">
		<include name="tools/**" />
		<exclude name=".svn" />
	</fileset>

	<!-- 3rd party extensions -->
	<fileset dir="." id="files.3rd-ext">
		<include name="ext-3rd/**" />
		<exclude name=".svn" />
	</fileset>

	<!-- 3rd party: jQuery -->
	<fileset dir="3rdparty/jquery" id="files.3rd.jquery">
		<include name="**" />
		<exclude name=".svn" />
	</fileset>

	<!-- 3rd party: Tiny MCE -->
	<fileset dir="3rdparty/tiny_mce" id="files.3rd.tiny_mce">
		<include name="**" />
		<exclude name=".svn" />
	</fileset>


	<!-- SDK files -->
	<fileset dir="." id="SDK_files">
		<include name="SDK/**" />
		<exclude name=".svn" />
	</fileset>

	<!-- Auto tests -->
	<fileset dir="tests" id="files.tests">
		<include name="**" />
		<exclude name=".svn" />
	</fileset>

</project>
