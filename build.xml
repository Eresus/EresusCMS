<?xml version="1.0" encoding="UTF-8"?>

<project name="eresus2" default="build" basedir="./">

	<property file="build.properties" />

	<!--
		Build only main targets
	-->
	<target name="core" description="Build only core modules">

		<mkdir dir="${builddir}" />

		<copy todir="${builddir}">
			<fileset refid="main_files" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>

		<copy todir="${builddir}/core/lib">
			<fileset refid="libs_files" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>

		<copy todir="${builddir}/">
			<fileset refid="l10n_files" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>

	</target>

	<!--
		Build project
	-->
	<target name="build" depends="core" description="Build basic set of modules">

		<mkdir dir="${builddir}/distrib" />
		<copy todir="${builddir}/distrib">
			<fileset refid="db_files" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>

		<copy todir="${builddir}">
			<fileset refid="3rdparty_files" />
		</copy>

	</target>

	<!--
		Build all
	-->
	<target name="all" depends="build" description="Build all modules">

		<mkdir dir="${builddir}/distrib" />
		<copy todir="${builddir}/distrib">
			<fileset refid="SDK_files" />
			<filterchain>
			    <expandproperties />
		  </filterchain>
		</copy>

	</target>


	<!--
		Run unit tests
	-->
	<target name="test" depends="core" description="Run unit tests">

		<copy todir="${builddir}">
			<fileset refid="tests_files" />
		</copy>

		<phpunit printsummary="true">
			<formatter type="plain" usefile="false" />
			<batchtest>
				<fileset dir="${builddir}/t">
					<include name="init.php"/>
					<include name="**/*Test.php"/>
					<exclude name="**/AllTests.php"/>
				</fileset>
			</batchtest>
		</phpunit>

	</target>

	<!-- - - - - - - - - - - - - - - - - - - - - -->

	<!-- Main project files -->
	<fileset dir="main" id="main_files">
		<include name="**" />
		<exclude name=".svn" />
	</fileset>

	<!-- libs files -->
	<fileset dir="lib" id="libs_files">
		<include name="**" />
		<exclude name=".svn" />
	</fileset>

	<!-- DB templates -->
	<fileset dir="db" id="db_files">
		<include name="**" />
		<exclude name=".svn" />
	</fileset>

	<!-- l10n files -->
	<fileset dir="." id="l10n_files">
		<include name="lang/**" />
		<exclude name=".svn" />
	</fileset>

	<!-- 3rd party extensions -->
	<fileset dir="." id="3rdparty_files">
		<include name="ext-3rd/**" />
		<exclude name=".svn" />
	</fileset>

	<!-- SDK files -->
	<fileset dir="." id="SDK_files">
		<include name="SDK/**" />
		<exclude name=".svn" />
	</fileset>

	<!-- Unit tests -->
	<fileset dir="." id="tests_files">
		<include name="t/**" />
		<exclude name=".svn" />
	</fileset>

</project>
